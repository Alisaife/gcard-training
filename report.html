<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>تقرير تنفيذ استراتيجية داخل الصف - A4 PDF</title>

<!-- خط نظيف (اختياري عبر إنترنت) -->
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

<style>
/* ========== Reset ========== */
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:#f3f4f6;color:#0f172a;font:16px/1.6 "Cairo",system-ui,-apple-system,Segoe UI,Arial}
h1,h2,h3{margin:0 0 .6rem}
p{margin:.4rem 0}

/* ========== Theme ========== */
:root{
  --brand:#2563eb; --brand-ink:#1e3a8a;
  --ink:#0f172a; --muted:#475569; --line:#e5e7eb; --bg:#ffffff;
  --paper:#ffffff; --badge:#eef2ff; --badge-ink:#3730a3;
}

/* ========== Layout ========== */
.container{max-width:1200px;margin:auto;padding:18px}
.app{
  display:grid;gap:16px;
  grid-template-columns: 380px 1fr;
}
@media(max-width:1024px){.app{grid-template-columns:1fr}}
.card{background:var(--bg);border:1px solid var(--line);border-radius:14px;padding:16px}

/* Sidebar form */
.form h2{font-size:1.05rem;color:var(--brand-ink)}
.field{margin-bottom:12px}
label{display:block;font-weight:700;margin-bottom:6px}
input[type="text"],input[type="date"],select,textarea{
  width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff
}
textarea{min-height:90px;resize:vertical}
.help{color:var(--muted);font-size:.9rem}

/* Buttons */
.btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
button{
  appearance:none;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer
}
.btn-primary{background:var(--brand);color:#fff}
.btn-ghost{background:#eef2ff;color:var(--brand-ink)}
.btn-danger{background:#fee2e2;color:#7f1d1d}
.btn-ok{background:#e8f9ef;color:#065f46}
.row{display:grid;gap:10px}
.row-2{grid-template-columns:1fr 1fr}
.row-3{grid-template-columns:repeat(3,1fr)}
@media(max-width:480px){.row-2,.row-3{grid-template-columns:1fr}}

/* Table */
table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line);border-radius:12px;overflow:hidden}
th,td{border-bottom:1px solid var(--line);padding:10px;vertical-align:top}
tr:last-child td{border-bottom:none}
th{background:#f8fafc;text-align:right;font-weight:700}

/* Activities editor */
.table-mini th, .table-mini td{padding:8px}
.table-mini th:nth-child(1){width:42px}
.table-mini th:nth-child(3){width:120px}
.table-mini th:nth-child(4){width:180px}
.table-mini th:last-child{width:76px}

/* ========== Preview Sheet (A4) ========== */
.preview-wrap{display:flex;justify-content:center;align-items:flex-start}
.sheet{
  background:var(--paper); color:#111827; width:210mm; min-height:297mm;
  padding:14mm; border:1px solid var(--line); border-radius:0;
  box-shadow:0 10px 30px rgba(0,0,0,.08); position:relative;
  print-color-adjust:exact; -webkit-print-color-adjust:exact;
}
.header{
  display:flex;justify-content:space-between;align-items:center;
  border-bottom:2px solid var(--line);padding-bottom:8px;margin-bottom:10px
}
.header .title{font-size:1.15rem}
.badge{display:inline-block;background:var(--badge);color:var(--badge-ink);padding:.2rem .6rem;border-radius:999px;font-weight:700;font-size:.9rem;border:1px solid #e0e7ff}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin:10px 0 12px}
.kpis .k{border:1px solid var(--line);border-radius:10px;padding:8px}
.section{margin:10px 0}
.meta th{width:200px}
.section h3{font-size:1rem;color:#0f172a;border-right:4px solid var(--brand);padding-right:8px;margin-bottom:6px}
.section ul{margin:.2rem 1rem}
.footer{
  margin-top:14px;border-top:1px dashed var(--line);padding-top:8px;
  display:flex;justify-content:space-between;color:#475569;font-size:.95rem
}
.watermark{position:absolute;inset:auto 0 10mm 0;opacity:.06;text-align:center;font-size:38px;font-weight:700;pointer-events:none}

/* Page-break control */
.avoid-break{page-break-inside:avoid;break-inside:avoid}
.pb{page-break-before:always;break-before:page}

/* Print rules */
@media print{
  body{background:#fff}
  .container>.app>.card.form,
  .top-actions{display:none !important}
  .sheet{border:none;box-shadow:none;width:auto;min-height:auto;padding:0}
  @page{size:A4;margin:12mm}
}

/* Small niceties */
hr.sep{border:0;border-top:1px solid var(--line);margin:10px 0}
</style>
</head>
<body>

<div class="container">
  <div class="top-actions btns" style="justify-content:flex-end">
    <button class="btn-ghost" onclick="window.scrollTo({top:0,behavior:'smooth'})">أعلى</button>
    <button class="btn-primary" id="printTop">طباعة</button>
    <button class="btn-ghost" id="dlTop">تحميل PDF</button>
  </div>

  <div class="app">
    <!-- ================== FORM ================== -->
    <div class="card form" id="formCard">
      <h2>نموذج الإدخال</h2>
      <p class="help">املأ الحقول ثم اضغط معاينة. كل قسم يظهر بتنسيق مرتب في التقرير.</p>

      <div class="row row-3">
        <div class="field"><label>المدرسة</label><input id="school" type="text" placeholder="اسم المدرسة"></div>
        <div class="field"><label>القسم/المادة</label><input id="subject" type="text" placeholder="مثال: رياضيات"></div>
        <div class="field"><label>التاريخ</label><input id="date" type="date"></div>
      </div>

      <div class="row row-3">
        <div class="field"><label>المعلم/ـة</label><input id="teacher" type="text" placeholder="اسم المعلم/ـة"></div>
        <div class="field"><label>الصف</label><input id="grade" type="text" placeholder="مثال: خامس أ"></div>
        <div class="field"><label>الحصة</label><input id="period" type="text" placeholder="مثال: الثالثة"></div>
      </div>

      <div class="row row-2">
        <div class="field">
          <label>اسم الاستراتيجية</label>
          <select id="strategy">
            <option value="">— اختر —</option>
            <option>التعلم الذاتي</option>
            <option>التعلم التعاوني</option>
            <option>العصف الذهني</option>
            <option>التعلم القائم على المشروعات</option>
            <option>التعلم المقلوب</option>
            <option>فكر ـ زاوج ـ شارك</option>
            <option>محطات التعلم</option>
            <option>خرائط المفاهيم</option>
          </select>
        </div>
        <div class="field"><label>زمن التنفيذ</label><input id="duration" type="text" placeholder="مثال: 45 دقيقة"></div>
      </div>

      <div class="row row-2">
        <div class="field"><label>الأهداف التعليمية</label><textarea id="goals" placeholder="كل هدف في سطر مستقل"></textarea></div>
        <div class="field"><label>المهارات المستهدفة</label><textarea id="skills" placeholder="التفكير الناقد، التواصل، حل المشكلات..."></textarea></div>
      </div>

      <div class="row row-2">
        <div class="field"><label>التهيئة والإجراءات</label><textarea id="steps" placeholder="التمهيد، العرض، التقويم البنائي..."></textarea></div>
        <div class="field"><label>الموارد والوسائل</label><textarea id="materials" placeholder="كتاب، سبورة ذكية، أوراق عمل، روابط رقمية"></textarea></div>
      </div>

      <div class="field">
        <label>أنشطة المتعلمين</label>
        <table class="table-mini" id="actEdit">
          <thead>
            <tr><th>#</th><th>وصف النشاط</th><th>الزمن</th><th>أداة التقويم</th><th>إجراء</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="btns" style="margin-top:8px">
          <button class="btn-ghost" id="addAct">إضافة نشاط</button>
          <button class="btn-danger" id="clearAct">حذف الكل</button>
        </div>
      </div>

      <div class="row row-2">
        <div class="field"><label>التقويم والدليل</label><textarea id="assessment" placeholder="أسئلة قصيرة، بطاقة ملاحظة، روبريك، نموذج Google"></textarea></div>
        <div class="field"><label>الملاحظات</label><textarea id="notes" placeholder="ما الذي نجح؟ ما الذي يلزم تحسينه؟"></textarea></div>
      </div>

      <div class="row row-2">
        <div class="field"><label>النتائج والمؤشرات</label><textarea id="outcomes" placeholder="نسبة إنجاز الهدف، تفاعل الطلاب، شواهد"></textarea></div>
        <div class="field"><label>التوصيات والإجراءات اللاحقة</label><textarea id="reco" placeholder="خطوة علاجية، إثرائية، واجب، إعادة تخطيط"></textarea></div>
      </div>

      <hr class="sep">

      <div class="btns">
        <button class="btn-primary" id="previewBtn">معاينة</button>
        <button class="btn-ghost" id="printBtn">طباعة</button>
        <button class="btn-ghost" id="downloadBtn">تحميل PDF</button>
        <button class="btn-danger" id="resetBtn">تفريغ</button>
      </div>
      <p class="help">ملاحظة: زر الطباعة يحفظ PDF بدقة A4 من متصفحك. زر التحميل يستخدم مولّد PDF تلقائي.</p>
    </div>

    <!-- ================== PREVIEW ================== -->
    <div class="card">
      <div class="preview-wrap">
        <div class="sheet" id="sheet">
          <div class="header avoid-break">
            <div>
              <div class="title">تقرير تنفيذ استراتيجية داخل الصف</div>
              <span class="badge" id="tagStrategy">—</span>
            </div>
            <div style="text-align:left">
              <small id="genTime"></small><br>
              <small>قياس: A4</small>
            </div>
          </div>

          <div class="kpis avoid-break">
            <div class="k"><b>المدرسة:</b> <span id="rSchool">—</span></div>
            <div class="k"><b>المعلم/ـة:</b> <span id="rTeacher">—</span></div>
            <div class="k"><b>القسم/المادة:</b> <span id="rSubject">—</span></div>
            <div class="k"><b>التاريخ:</b> <span id="rDate">—</span></div>
          </div>

          <table class="meta avoid-break">
            <tr><th>الصف</th><td id="rGrade">—</td></tr>
            <tr><th>الحصة</th><td id="rPeriod">—</td></tr>
            <tr><th>زمن التنفيذ</th><td id="rDuration">—</td></tr>
          </table>

          <div class="section avoid-break">
            <h3>الأهداف التعليمية</h3>
            <ul id="rGoals"></ul>
          </div>

          <div class="section avoid-break">
            <h3>المهارات المستهدفة</h3>
            <p id="rSkills">—</p>
          </div>

          <div class="section avoid-break">
            <h3>التهيئة والإجراءات</h3>
            <p id="rSteps">—</p>
          </div>

          <div class="section avoid-break">
            <h3>الموارد والوسائل</h3>
            <p id="rMaterials">—</p>
          </div>

          <div class="section">
            <h3>أنشطة المتعلمين</h3>
            <table>
              <thead><tr><th style="width:42px">#</th><th>الوصف</th><th style="width:120px">الزمن</th><th style="width:200px">أداة التقويم</th></tr></thead>
              <tbody id="rActivities"></tbody>
            </table>
          </div>

          <div class="section avoid-break">
            <h3>التقويم والدليل</h3>
            <p id="rAssessment">—</p>
          </div>

          <div class="section avoid-break">
            <h3>الملاحظات</h3>
            <p id="rNotes">—</p>
          </div>

          <div class="section avoid-break">
            <h3>النتائج والمؤشرات</h3>
            <p id="rOutcomes">—</p>
          </div>

          <div class="section avoid-break">
            <h3>التوصيات والإجراءات اللاحقة</h3>
            <p id="rReco">—</p>
          </div>

          <div class="footer avoid-break">
            <span>تم التوليد: <span id="rStamp">—</span></span>
            <span>توقيع المعلم/ـة: ____________</span>
          </div>

          <div class="watermark">School Report</div>
        </div>
      </div>

      <div class="btns" style="justify-content:center;margin-top:10px">
        <button class="btn-ghost" onclick="window.scrollTo({top:0,behavior:'smooth'})">عودة لأعلى</button>
        <button class="btn-primary" id="printBtn2">طباعة</button>
        <button class="btn-ghost" id="downloadBtn2">تحميل PDF</button>
      </div>
    </div>
  </div>
</div>

<!-- مكتبة PDF اختيارية -->
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
<script>
const $=s=>document.querySelector(s);
const $$=s=>document.querySelectorAll(s);
const todayISO=()=>new Date().toISOString().slice(0,10);

// Defaults
$('#date').value=todayISO();

// Activities editor
const actBody = $('#actEdit tbody');
function renumber(){[...actBody.rows].forEach((r,i)=>r.cells[0].textContent=i+1)}
function addActRow(data={desc:'',time:'',tool:''}){
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td></td>
    <td><textarea placeholder="وصف مختصر للنشاط" style="width:100%;min-height:60px">${data.desc||''}</textarea></td>
    <td><input type="text" placeholder="10 د" value="${data.time||''}" style="width:100%"></td>
    <td><input type="text" placeholder="بطاقة ملاحظة/سؤال..." value="${data.tool||''}" style="width:100%"></td>
    <td style="text-align:center">
      <button type="button" class="btn-danger rm" style="padding:6px 10px;font-weight:700">حذف</button>
    </td>
  `;
  actBody.appendChild(tr); renumber();
}
$('#addAct').addEventListener('click',()=>addActRow());
$('#clearAct').addEventListener('click',()=>{actBody.innerHTML=''; renumber()});
actBody.addEventListener('click',e=>{
  if(e.target.classList.contains('rm')){ e.target.closest('tr').remove(); renumber(); }
});
addActRow(); // seed 1

// Collect
function getVal(id){return (document.getElementById(id).value||'').trim()}
function collect(){
  const goals = getVal('goals').split('\n').map(s=>s.trim()).filter(Boolean);
  const activities = [...actBody.rows].map(r=>({
    desc:r.cells[1].querySelector('textarea').value.trim(),
    time:r.cells[2].querySelector('input').value.trim(),
    tool:r.cells[3].querySelector('input').value.trim(),
  })).filter(a=>a.desc||a.time||a.tool);

  return {
    school:getVal('school'), subject:getVal('subject'), date:getVal('date'),
    teacher:getVal('teacher'), grade:getVal('grade'), period:getVal('period'),
    strategy:getVal('strategy'), duration:getVal('duration'),
    goals, skills:getVal('skills'), steps:getVal('steps'),
    materials:getVal('materials'), activities,
    assessment:getVal('assessment'), notes:getVal('notes'),
    outcomes:getVal('outcomes'), reco:getVal('reco'),
  };
}

// Fill preview
function fill(d){
  const set=(id,val)=>document.getElementById(id).textContent= val||'—';
  set('rSchool', d.school); set('rTeacher', d.teacher); set('rSubject', d.subject);
  set('rDate', d.date); set('rGrade', d.grade); set('rPeriod', d.period); set('rDuration', d.duration);
  $('#tagStrategy').textContent = d.strategy || '—';

  // Goals
  const ul=$('#rGoals'); ul.innerHTML='';
  if(d.goals.length){ d.goals.forEach(g=>{const li=document.createElement('li'); li.textContent=g; ul.appendChild(li);}); }
  else{ const li=document.createElement('li'); li.textContent='—'; ul.appendChild(li); }

  set('rSkills', d.skills); set('rSteps', d.steps); set('rMaterials', d.materials);

  // Activities
  const rtbody=$('#rActivities'); rtbody.innerHTML='';
  if(d.activities.length){
    d.activities.forEach((a,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${i+1}</td><td>${a.desc||'—'}</td><td>${a.time||'—'}</td><td>${a.tool||'—'}</td>`;
      rtbody.appendChild(tr);
    });
  }else{
    const tr=document.createElement('tr'); tr.innerHTML='<td colspan="4" style="text-align:center;color:#64748b">لا توجد أنشطة</td>';
    rtbody.appendChild(tr);
  }

  set('rAssessment', d.assessment); set('rNotes', d.notes); set('rOutcomes', d.outcomes); set('rReco', d.reco);
  const now=new Date(); $('#genTime').textContent='وقت التوليد: '+ now.toLocaleString('ar-SA'); $('#rStamp').textContent=now.toLocaleString('ar-SA');
}

// Print and PDF
function ensureLatest(){ fill(collect()); }
function doPrint(){ ensureLatest(); setTimeout(()=>window.print(), 30); }
async function downloadPDF(){
  ensureLatest();
  const el = $('#sheet');
  const opt = {
    margin:[10,10,10,10],
    filename:'تقرير-تنفيذ-الاستراتيجية.pdf',
    image:{type:'jpeg',quality:0.98},
    html2canvas:{scale:2,useCORS:true,background:'#ffffff',scrollY:0},
    jsPDF:{unit:'mm',format:'a4',orientation:'portrait'},
    pagebreak:{mode:['css','legacy']}
  };
  if(typeof html2pdf!=='undefined'){ await html2pdf().set(opt).from(el).save(); }
  else{ alert('مولّد PDF غير متوفر. استخدم زر الطباعة لحفظ PDF.'); }
}

// Bind
$('#previewBtn').addEventListener('click', ()=>{ fill(collect()); $('#sheet').scrollIntoView({behavior:'smooth'}); });
$('#printBtn').addEventListener('click', doPrint);
$('#printBtn2').addEventListener('click', doPrint);
$('#printTop').addEventListener('click', doPrint);
$('#downloadBtn').addEventListener('click', downloadPDF);
$('#downloadBtn2').addEventListener('click', downloadPDF);
$('#dlTop').addEventListener('click', downloadPDF);

$('#resetBtn').addEventListener('click', ()=>{
  if(!confirm('تفريغ جميع الحقول؟')) return;
  $$('input, textarea, select').forEach(el=>{
    if(el.type==='date') el.value=todayISO(); else if(el.tagName==='SELECT') el.value=''; else el.value='';
  });
  actBody.innerHTML=''; addActRow();
  fill(collect());
  window.scrollTo({top:0,behavior:'smooth'});
});

// Initial fill
fill(collect());
</script>
</body>
</html>
